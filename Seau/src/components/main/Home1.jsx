// Home.jsx
import React, { useEffect, useState, useContext } from 'react'
import { useNavigate } from 'react-router-dom'
import { UserContext } from '../../context/UserContext'
import Weather from './Weather'
import KakaoMap from './KakaoMap'
import getDistance from './getDistance'
import '../../style/Seau.css'
import '../../style/ScheduleManagement.css'
import axios from 'axios'

const busyColor = {
  ÏõêÌôú: 'item',
  ÌòºÏû°: 'itemBusy',
  Ïù¥Ïö©Î∂àÍ∞Ä: 'itemDont',
}

const INITIAL_CENTER = { lat: 33.36167, lng: 126.52917 }

const Home = () => {
  const nav = useNavigate()
  const { userId, setUserId, isOauth, setIsOauth, userData } = useContext(UserContext)
  const [selectedLocation, setSelectedLocation] = useState(null)
  const [mediaData, setMediaData] = useState(null)
  const [loading, setLoading] = useState(false)
  const [leftPanelOpen, setLeftPanelOpen] = useState(false)
  const [rightPanelOpen, setRightPanelOpen] = useState(false)
  const [mapCenter, setMapCenter] = useState(INITIAL_CENTER)
  const [mapLevel, setMapLevel] = useState(9)
  const [selectedPlace, setSelectedPlace] = useState(null)
  const [rightTab, setRightTab] = useState('info')
  const [scheduleList, setScheduleList] = useState([])
  const [scheduleMemberList, setScheduleMemberList] = useState([])
  const [expandedScheduleIdx, setExpandedScheduleIdx] = useState(null)
  const [nearbyAttractions, setNearbyAttractions] = useState([])
  const [nearestBeachName, setNearestBeachName] = useState(null)
  const [showSchedule, setShowSchedule] = useState(false)
  const [activeScheduleId, setActiveScheduleId] = useState(null);
  const [nearbySchedule, setNearbySchedule] = useState([])
  const [scheduleSubTab, setScheduleSubTab] = useState('user');
  const [matchedSchedulePlaces, setMatchedSchedulePlaces] = useState([]);

  const handleLocationSelect = async (location, imageUrl, placeInfo = null) => {
    const normalizedPrev = selectedPlace ? normalizeName(selectedPlace.name) : '';
    const normalizedNew = placeInfo ? normalizeName(placeInfo.name) : '';
    console.log('handleLocationSelect Ìò∏Ï∂ú:', { location, imageUrl, placeInfo, selectedPlace });

    const isSameLocation = selectedLocation &&
      Math.abs(selectedLocation.lat - location.lat) < 0.0001 &&
      Math.abs(selectedLocation.lng - location.lng) < 0.0001;

    const isSamePlace = normalizedPrev === normalizedNew;

    console.log('isSameLocation:', isSameLocation, 'isSamePlace:', isSamePlace);

    if (isSameLocation && isSamePlace) return;

    setLoading(true)
    setSelectedLocation(location)
    setSelectedPlace(placeInfo)
    setMediaData(imageUrl ? { image: [imageUrl], videos: [] } : { image: [], videos: [] })

    setTimeout(() => {
      setLeftPanelOpen(true)
      setRightPanelOpen(true)
      setMapCenter(location)
      setMapLevel(imageUrl ? 3 : 9)
      setLoading(false)
    }, 100)
  }

  const handleImageClick = (location, imageUrl, placeInfo) => {
    handleLocationSelect(location, imageUrl, placeInfo)
  }

  const handleNearbyMarkersChange = (nearby) => {
    setNearbyAttractions(nearby)
  }

  const handleScheduleChange = (schedules) => {
    setScheduleList(schedules)
  }

  const handleScheduleMemberChange = (scheduleMembers) => {
    setScheduleMemberList(scheduleMembers)
  }

  const handleApply = async (scheduleId) => {
    try {
      if (!userId) {
        alert('Î°úÍ∑∏Ïù∏Ïù¥ ÌïÑÏöîÌï©ÎãàÎã§.');
        nav('/login');
        return;
      }

      const response = await axios.post('http://localhost:3001/schedule/apply', {
        schedule_id: scheduleId,
        user_id: userId,
      });

      if (response.data.success) {
        alert('Ïã†Ï≤≠ ÏÑ±Í≥µ!');
        setScheduleMemberList(prev => [
          ...prev,
          {
            schedule_id: scheduleId,
            req_user_id: userId,
            req_status: 0
          }
        ]);
      } else {
        // success: false Ïù¥ÏßÄÎßå ÌäπÏ†ï Î©îÏãúÏßÄÍ∞Ä ÏïÑÎãå Í≤ΩÏö∞
        alert('Ïã†Ï≤≠ Ïã§Ìå®: ' + response.data.message);
      }
    } catch (error) {
      console.error('Ïã†Ï≤≠ Ï§ë Ïò§Î•ò:', error); // ÏΩòÏÜîÏóêÏÑú Ïñ¥Îñ§ Ïò§Î•ò Í∞ùÏ≤¥Í∞Ä ÎÑòÏñ¥Ïò§ÎäîÏßÄ ÌôïÏù∏
      console.error('Error response:', error.response); // ÌäπÌûà Ïù¥ Î∂ÄÎ∂ÑÏùÑ ÌôïÏù∏

      // ÏÑúÎ≤ÑÏóêÏÑú Î≥¥ÎÇ∏ ÌäπÏ†ï ÏóêÎü¨ Î©îÏãúÏßÄ Ï≤òÎ¶¨ (ÌîÑÎ°úÌïÑ Ï†ïÎ≥¥ ÎàÑÎùΩ)
      // error.responseÍ∞Ä ÏûàÍ≥†, statusÍ∞Ä 403Ïù¥Î©∞, data.messageÍ∞Ä 'UserProfileIncomplete'Ïù∏ÏßÄ Ï†ïÌôïÌûà ÌôïÏù∏
      if (error.response && error.response.status === 403 && error.response.data.message === 'UserProfileIncomplete') {
        const confirmMove = window.confirm('ÌîÑÎ°úÌïÑÏóêÏÑú ÏÉùÎÖÑÏõîÏùº, ÏÑ±Î≥Ñ, Ï†ÑÌôîÎ≤àÌò∏Î•º ÏÑ§Ï†ïÌïòÍ≥† Ïã†Ï≤≠Ìï¥Ï£ºÏÑ∏Ïöî!');
        if (confirmMove) {
          nav('/mypage2'); // ÎßàÏù¥ÌéòÏù¥ÏßÄÎ°ú ÏûêÎèô Ïù¥Îèô
        }
      }
      // Ï§ëÎ≥µ Ïã†Ï≤≠ Ïò§Î•ò Ï≤òÎ¶¨
      else if (error.response && error.response.status === 409) {
        alert('Ïù¥ÎØ∏ Ïã†Ï≤≠Îêú Ïä§ÏºÄÏ§ÑÏûÖÎãàÎã§.');
      }
      // Í∑∏ Ïô∏Ïùò ÏùºÎ∞òÏ†ÅÏù∏ ÎÑ§Ìä∏ÏõåÌÅ¨ ÎòêÎäî ÏÑúÎ≤Ñ Ïò§Î•ò
      else {
        alert('Ïã†Ï≤≠ Ï§ë Ïïå Ïàò ÏóÜÎäî Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
      }
    }
  };

  // --- Ïã†Ï≤≠ Ï∑®ÏÜå Ï≤òÎ¶¨ Ìï®Ïàò Ï∂îÍ∞Ä ---
  const handleCancelApplication = async (scheduleId) => {
    if (!userId) {
      alert('Î°úÍ∑∏Ïù∏ ÌõÑ Ïã†Ï≤≠ÏùÑ Ï∑®ÏÜåÌï† Ïàò ÏûàÏäµÎãàÎã§.');
      return;
    }
    if (!window.confirm('Ï†ïÎßêÎ°ú Ïù¥ Ïä§ÏºÄÏ§Ñ Ïã†Ï≤≠ÏùÑ Ï∑®ÏÜåÌïòÏãúÍ≤†ÏäµÎãàÍπå?')) {
      return;
    }

    try {
      const response = await fetch('http://localhost:3001/schedule/cancel_apply', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          scheduleId: scheduleId,
          userId: userId, // ÌòÑÏû¨ Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©Ïûê ID
        }),
      });

      const data = await response.json();

      if (data.success) {
        alert('Ïä§ÏºÄÏ§Ñ Ïã†Ï≤≠Ïù¥ ÏÑ±Í≥µÏ†ÅÏúºÎ°ú Ï∑®ÏÜåÎêòÏóàÏäµÎãàÎã§!');
        // Ïã†Ï≤≠ Ï∑®ÏÜå ÌõÑ scheduleMemberList Í∞±Ïã†: Ìï¥Îãπ Ïã†Ï≤≠ÏùÑ Î™©Î°ùÏóêÏÑú Ï†úÍ±∞
        setScheduleMemberList(prev => prev.filter(
          m => !(m.schedule_id === scheduleId && m.req_user_id === userId)
        ));
        // ÌïÑÏöîÌïòÎã§Î©¥, Ïä§ÏºÄÏ§Ñ Î¶¨Ïä§Ìä∏(Ï∞∏Ïó¨Ïûê Ïàò)ÎèÑ Í∞±Ïã†ÌïòÎäî Î°úÏßÅÏùÑ Ï∂îÍ∞ÄÌï¥Ïïº Ìï©ÎãàÎã§.
        // ÌòÑÏû¨ Home.jsxÏóêÏÑúÎäî scheduleListÎ•º ÏßÅÏ†ë fetchÌïòÏßÄ ÏïäÏúºÎØÄÎ°ú,
        // KakaoMap Ïª¥Ìè¨ÎÑåÌä∏Ïùò scheduleList propÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ÎêòÎ©¥ ÏûêÎèôÏúºÎ°ú Î∞òÏòÅÎê† Í≤ÉÏûÖÎãàÎã§.
      } else {
        alert(`Ïä§ÏºÄÏ§Ñ Ïã†Ï≤≠ Ï∑®ÏÜå Ïã§Ìå®: ${data.message}`);
      }
    } catch (err) {
      console.error('Ïä§ÏºÄÏ§Ñ Ïã†Ï≤≠ Ï∑®ÏÜå Ï§ë Ïò§Î•ò Î∞úÏÉù:', err);
      alert('Ïä§ÏºÄÏ§Ñ Ïã†Ï≤≠ Ï∑®ÏÜå Ï§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.');
    }
  };
  // --- Ïã†Ï≤≠ Ï∑®ÏÜå Ï≤òÎ¶¨ Ìï®Ïàò ÎÅù ---


  const handleLogButton = () => {
    if (isOauth) {
      setIsOauth(false)
      setUserId("")
    }
    nav('/')
  }

  const filteredCategories = {
    attractions: nearbyAttractions.filter(item => item.type === 'Í¥ÄÍ¥ëÏßÄ'),
    restaurants: nearbyAttractions.filter(item => item.type === 'ÎßõÏßë'),
    activities: nearbyAttractions.filter(item => item.type === 'Î†àÏ†Ä')
  }

  const renderPlaceItems = (places, excludeName) =>
    places.filter(p => p.name !== excludeName).map((place, idx) => (
      <div key={idx} className={place.busy ? busyColor[place.busy] : 'item'} onClick={() => handleImageClick({ lat: place.lat, lng: place.lng }, place.image, place)}>
        <div className="itemName">{place.name}</div>
        <div className="itemInfo">Í±∞Î¶¨: {getDistance(selectedLocation.lat, selectedLocation.lng, place.lat, place.lng).toFixed(2)} km</div>
      </div>
    ))

  const filteredSchedules = nearbySchedule.filter(schedule =>
    scheduleSubTab === 'user'
      ? schedule.scheduleType === 0
      : schedule.scheduleType === 1
  );

  const normalizeName = (str) =>
    str.toLowerCase().replace(/\s/g, '').replace(/[^a-z0-9Í∞Ä-Ìû£]/g, '')

  useEffect(() => {
    if (selectedLocation && selectedPlace && !loading) {
      setLeftPanelOpen(true);
      setRightPanelOpen(true);
      console.log('selectedPlace.source:', selectedPlace?.source);
      console.log('typeof source:', typeof selectedPlace?.source);
      console.log('üî• ÌòÑÏû¨ selectedPlace:', selectedPlace);
      console.log('üî• Ï°∞Í±¥ ÌèâÍ∞Ä:', selectedPlace?.source !== 'schedule');
    }
  }, [selectedLocation, selectedPlace, loading]);

  useEffect(() => {
    const newMatches = nearbySchedule.map(schedule => {
      const matchedPlace = nearbyAttractions.find(place =>
        (Math.abs(place.lat - schedule.lat) < 0.0001 && Math.abs(place.lng - schedule.lng) < 0.0001) ||
        normalizeName(place.name).includes(normalizeName(schedule.location)) ||
        normalizeName(schedule.location).includes(normalizeName(place.name))
      );

      return {
        scheduleId: schedule.scheduleId,
        matchedPlace: matchedPlace || null
      };
    });

    setMatchedSchedulePlaces(newMatches);
  }, [nearbySchedule, nearbyAttractions]);

  // console.log(scheduleMemberList)
  // console.log(nearbySchedule)
  // console.log(nearbyAttractions)
  console.log(selectedPlace)

  return (
    <div className="container">
      {/* ÏßÄÎèÑ */}
      <div className="mapContainer">
        <KakaoMap
          selectedLocation={selectedLocation}
          onLocationSelect={handleLocationSelect}
          onNearbyMarkersChange={handleNearbyMarkersChange}
          mapCenter={mapCenter}
          mapLevel={mapLevel}
          onMapLevelChange={setMapLevel}
          scheduleList={scheduleList}
          onScheduleChange={handleScheduleChange}
          onScheduleMemberChange={handleScheduleMemberChange}
          showSchedule={showSchedule}
          onNearestBeachChange={(beach) => setNearestBeachName(beach?.name || null)}
          activeScheduleId={activeScheduleId}
          setActiveScheduleId={setActiveScheduleId}
          onNearbyScheduleChange={setNearbySchedule}
        />
      </div>

      {/* Ï¢åÏ∏° Ìå®ÎÑê */}
      <div className="leftPanel" style={{ transform: leftPanelOpen ? 'translateX(0)' : 'translateX(-100%)' }}>
        <div className="panelHeader">
          <h3>üéØ Ï£ºÎ≥Ä Í¥ÄÍ¥ëÏßÄ</h3>
          <button className="closeButton" onClick={() => setLeftPanelOpen(false)}>√ó</button>
        </div>

        {nearestBeachName && <h3 style={{ marginBottom: 0 }}>{nearestBeachName}</h3>}
        <div className='panelContent'>
          {selectedPlace && (selectedPlace?.source?.trim() ?? '') !== 'schedule' && (
            <div className='schedule-card' style={{ width: '295px' }}>
              <div className={selectedPlace?.busy ? busyColor[selectedPlace?.busy] : 'item'} style={{ marginBottom: '0px' }}>
                <div className="itemName">{selectedPlace?.name}</div>
                {mediaData?.image?.[0] && (
                  <div className="selectedImageContainer">
                    <img src={mediaData.image[0]} alt="ÏÑ†ÌÉùÎêú Ïù¥ÎØ∏ÏßÄ" className="largeImage" />
                  </div>
                )}
                <div className="itemInfo2">
                  <p className="card-description">
                    {selectedPlace?.description || 'ÏÑ§Î™Ö ÏóÜÏùå'}
                  </p>

                  {/* Ïö¥ÏòÅ ÏãúÍ∞Ñ */}
                  {selectedPlace?.operatingTime && (
                    <div className="card-detail">
                      <strong style={{ width: '67px' }}>Ïö¥ÏòÅÏãúÍ∞Ñ:</strong> {selectedPlace?.operatingTime}
                    </div>
                  )}

                  {/* Ïó∞ÎùΩÏ≤ò */}
                  {selectedPlace?.phone && (
                    <div className="card-detail">
                      <strong>Ïó∞ÎùΩÏ≤ò:</strong> {selectedPlace?.phone}
                    </div>
                  )}

                  {/* ÌòºÏû°ÎèÑ ÏÉÅÌÉú */}
                  {selectedPlace?.busy && (
                    <div className="card-detail">
                      <strong>ÌòÑÏû¨ ÏÉÅÌÉú:</strong> {selectedPlace?.busy}
                    </div>
                  )}
                </div>
              </div>
            </div>
          )}
        </div>

        {loading ? <div className="loading">Î°úÎî© Ï§ë...</div> :
          selectedLocation && nearbyAttractions.length > 0 ? (
            <div className="panelContent">
              <div className="section">
                <h3 style={{ marginTop: '05px' }}>üèõÔ∏è Í¥ÄÍ¥ëÏßÄ</h3>
                {filteredCategories.attractions.length ? renderPlaceItems(filteredCategories.attractions, selectedPlace?.name) : <div>Í∑ºÏ≤òÏóê Í¥ÄÍ¥ëÏßÄÍ∞Ä ÏóÜÏäµÎãàÎã§.</div>}
              </div>


              <div className="section">
                <h4>üçΩÔ∏è ÎßõÏßë</h4>
                {filteredCategories.restaurants.length ? renderPlaceItems(filteredCategories.restaurants, selectedPlace?.name) : <div>Í∑ºÏ≤òÏóê ÎßõÏßëÏù¥ ÏóÜÏäµÎãàÎã§.</div>}
              </div>

              <div className="section">
                <h4>üé™ Î†àÏ†Ä</h4>
                {filteredCategories.activities.length ? renderPlaceItems(filteredCategories.activities, selectedPlace?.name) : <div>Í∑ºÏ≤òÏóê Î†àÏ†Ä ÏóÖÏ≤¥Í∞Ä ÏóÜÏäµÎãàÎã§.</div>}
              </div>
            </div>
          ) : (
            <div className="placeholder">ÏßÄÎèÑÎ•º ÌÅ¥Î¶≠Ìï¥ Ïû•ÏÜåÎ•º ÏÑ†ÌÉùÌï¥Ï£ºÏÑ∏Ïöî.</div>
          )}
      </div>

      {/* Ïö∞Ï∏° Ìå®ÎÑê */}
      <div className="rightPanel" style={{ transform: rightPanelOpen ? 'translateX(0)' : 'translateX(100%)' }}>
        <div className="panelHeader">
          <h3>üå§Ô∏è Ï¢ÖÌï© Ï†ïÎ≥¥</h3>
          <button className="closeButton" onClick={() => setRightPanelOpen(false)}>√ó</button>
        </div>

        <div className="panelContent" style={{ overflowY: 'auto', maxHeight: 'calc(100vh - 100px)' }}>
          {selectedLocation && <Weather lat={selectedLocation.lat} lon={selectedLocation.lng} />}

          {/* ÌÉ≠ Î≤ÑÌäº */}
          <div className="tabButtons" style={{ display: 'flex', borderBottom: '1px solid #ccc', margin: '10px 0' }}>
            <button
              onClick={() => setRightTab('info')}
              style={{
                flex: 1,
                padding: 8,
                background: rightTab === 'info' ? '#eee' : 'transparent',
                border: 'none',
                borderBottom: rightTab === 'info' ? '2px solid #333' : 'none',
                cursor: 'pointer',
                fontWeight: 'bold'
              }}
            >
              ÏÉÅÏÑ∏ Ï†ïÎ≥¥
            </button>
            <button
              onClick={() => setRightTab('media')}
              style={{
                flex: 1,
                padding: 8,
                background: rightTab === 'media' ? '#eee' : 'transparent',
                border: 'none',
                borderBottom: rightTab === 'media' ? '2px solid #333' : 'none',
                cursor: 'pointer',
                fontWeight: 'bold'
              }}
            >
              Ï£ºÎ≥Ä ÏßÄÏó≠
            </button>
          </div>

          {rightTab === 'info' && (
            <>



              {showSchedule && (
                <>
                  {/* ÏÑúÎ∏åÌÉ≠ Î≤ÑÌäº */}
                  <div className="tabButtons" style={{ display: 'flex', marginBottom: '10px' }}>
                    <button
                      onClick={() => setScheduleSubTab('user')}
                      style={{
                        flex: 1,
                        padding: 6,
                        background: scheduleSubTab === 'user' ? '#ddd' : '#f9f9f9',
                        border: '1px solid #ccc',
                        cursor: 'pointer'
                      }}
                    >
                      ÏùºÎ∞ò ÏÇ¨Ïö©Ïûê ÏùºÏ†ï
                    </button>
                    <button
                      onClick={() => setScheduleSubTab('business')}
                      style={{
                        flex: 1,
                        padding: 6,
                        background: scheduleSubTab === 'business' ? '#ddd' : '#f9f9f9',
                        border: '1px solid #ccc',
                        cursor: 'pointer'
                      }}
                    >
                      Î†àÏ†Ä ÏóÖÏ≤¥ ÏùºÏ†ï
                    </button>
                  </div>

                  <h3 style={{ margin: '10px' }}>üìÖ ÏùºÏ†ï Î¶¨Ïä§Ìä∏</h3>
                  <div className="schedule-grid">
                    {filteredSchedules.map((schedule) => {
                      const approvCount = scheduleMemberList.filter(
                        (m) => m.schedule_id === schedule.scheduleId && m.req_status === 1
                      ).length;

                      const isApplied = scheduleMemberList.some(
                        (m) => m.schedule_id === schedule.scheduleId && m.req_user_id === userId
                      );

                      const isExpanded = expandedScheduleIdx === schedule.scheduleId;
                      return (
                        <div
                          key={schedule.scheduleId}
                          className="schedule-card"
                          onClick={() => {
                            console.log(schedule.scheduleType)
                            console.log(schedule.location)
                            console.log('Ï≤´ ÌÅ¥Î¶≠ - nearbyAttractions:', nearbyAttractions);
                            setExpandedScheduleIdx(prev => prev === schedule.scheduleId ? null : schedule.scheduleId);

                            const matched = matchedSchedulePlaces.find(p => p.scheduleId === schedule.scheduleId);
                            const matchedPlace = matched?.matchedPlace;

                            const location = { lat: schedule.lat, lng: schedule.lng };
                            const placeInfo = matchedPlace || {
                              name: schedule.title,
                              title: schedule.title,
                              description: schedule.description,
                              lat: schedule.lat,
                              lng: schedule.lng,
                              source: 'schedule',
                              location: schedule.location,
                            };

                            const imageUrl = matchedPlace?.image || schedule.scheduleImage || null;

                            handleImageClick(location, imageUrl, placeInfo);
                            setMapLevel(3);
                            setActiveScheduleId(schedule.scheduleId);

                          }}
                          style={{ cursor: 'pointer', width: '295px' }}
                        >

                          <div className="card-content" style={{ paddingTop: '10px', height: '50%' }}>
                            <h4 className="card-title">{schedule.title}</h4>
                            {schedule.scheduleImage && (
                              <img
                                src={schedule.scheduleImage}
                                alt="Schedule"
                                className="card-image"
                              />
                            )}
                            <div className="card-detail">
                              <strong>Ï∞∏Ïó¨Ïûê:</strong> {approvCount}/{schedule.maxPeople}Î™Ö
                            </div>

                            {isExpanded && (
                              <>
                                <p className="card-description">{schedule.description || 'ÏÑ§Î™Ö ÏóÜÏùå'}</p>
                                <div className="card-detail">
                                  <strong>ÎÇ†Ïßú:</strong> {new Date(schedule.Date).toLocaleString('ko-KR')}
                                </div>
                                <div className="card-detail">
                                  <strong>Ïû•ÏÜå:</strong> {schedule.location}
                                </div>
                                <div className="card-detail">
                                  <strong>ÎπÑÏö©:</strong> {schedule.perCost.toLocaleString()}Ïõê
                                </div>
                                <div className="card-detail">
                                  <strong>ÏÉÅÌÉú:</strong> {schedule.status}
                                </div>
                                <div className="card-actions">
                                  {/* user_typeÏù¥ 1Ïù¥ ÏïÑÎãê ÎïåÎßå Ïã†Ï≤≠/Ïã†Ï≤≠ÏôÑÎ£å Î≤ÑÌäºÏùÑ Î†åÎçîÎßÅ */}
                                  {userData && userData.user_type !== 1 && (
                                    <button
                                      className={`action-button ${isApplied ? 'close' : 'accept'}`}
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        if (!isApplied) handleApply(schedule.scheduleId);
                                      }}
                                      disabled={isApplied}
                                    >
                                      {isApplied ? 'Ïã†Ï≤≠ÏôÑÎ£å' : 'Ïã†Ï≤≠'}
                                    </button>
                                  )}

                                  {/* user_typeÏù¥ 1Ïù¥ ÏïÑÎãê ÎïåÎßå Ïã†Ï≤≠Ï∑®ÏÜå Î≤ÑÌäºÏùÑ Î†åÎçîÎßÅ */}
                                  {isApplied && userData && userData.user_type !== 1 && (
                                    <button
                                      className="action-button danger"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        handleCancelApplication(schedule.scheduleId);
                                      }}
                                    >
                                      Ïã†Ï≤≠Ï∑®ÏÜå
                                    </button>
                                  )}
                                </div>
                              </>
                            )}
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </>
              )}

            </>
          )}

          {rightTab === 'media' && (
            <div className="mediaSection imageGrid">
              {[...new Map(
                nearbyAttractions.filter(place =>
                  place.image && (!mediaData?.image?.includes(place.image))
                ).map(place => [place.image, place])
              ).values()].map((place, idx) => (
                <img
                  key={idx}
                  src={place.image}
                  alt={`ÎØ∏ÎîîÏñ¥ ${idx + 1}`}
                  className="mediaImage"
                  onClick={() => handleImageClick({ lat: place.lat, lng: place.lng }, place.image, place)}
                />
              ))}
            </div>
          )}
        </div>
      </div>

      {/* Ïä§ÏºÄÏ§Ñ Î≤ÑÌäº */}
      <div>
        <button
          className={`navButton ${showSchedule ? 'active' : ''}`}
          onClick={() => {
            const next = !showSchedule
            setShowSchedule(next)
            if (next) {
              // setSelectedLocation(INITIAL_CENTER)
              setRightPanelOpen(true)
              // setMapCenter(INITIAL_CENTER)
              // setMapLevel(10)
              const defaultSchedule = nearbySchedule[0]; // Ï£ºÎ≥Ä Ïä§ÏºÄÏ§ÑÏù¥ ÏûàÏùÑ Í≤ΩÏö∞ Ï≤´ Î≤àÏß∏ ÏÑ†ÌÉù
              if (expandedScheduleIdx) {
                setActiveScheduleId(expandedScheduleIdx);
              } else {
                setActiveScheduleId(null);  // ÌéºÏπúÍ≤å ÏóÜÏúºÎ©¥ null
              }
            } else {
              setRightPanelOpen(false)
              setActiveScheduleId(null)
            }
          }}
        >
          {showSchedule ? 'Ïä§ÏºÄÏ§Ñ ÎßàÏª§ Ïà®Í∏∞Í∏∞' : 'Ïä§ÏºÄÏ§Ñ ÎßàÏª§ Î≥¥Í∏∞'}
        </button>
      </div>
    </div>
  )
}

export default Home
